<template>
  <lightning-spinner if:true={loading} size="medium">
  </lightning-spinner>

  <!-- Header / Filters -->
  <article class="slds-card">
    <div class="slds-card__body slds-card__body_inner">
      <div class="scheduler-header-container">
        <div class="center-date-selector">
          <lightning-button
              variant="neutral"
              label={filterLabel}
              title="Toggle Filters"
              icon-name="utility:filterList"
              onclick={toggleFilters}
              disabled={dateDisabled}
              class="slds-p-around_xxx-small">
          </lightning-button>
  
          <lightning-combobox
            style="width: 33%;"
            name="progress"
            label="Choose Center"
            value={selectedCenter}
            placeholder="Select Center"
            options={centers}
            onchange={changeCenter}
            variant="label-hidden">
          </lightning-combobox>

          <lightning-input 
            type="date" 
            name="input8"  
            value={selectedDate}
            min="2023-01-01" 
            disabled={dateDisabled}
            onchange={changeDate}
            placeholder="Choose Date"
            variant="label-hidden"
            >
          </lightning-input>
        </div>

        <div class="scheduler-header-actions" style="justify-content: flex-end;">
          <lightning-button
            variant="brand"
            label="New Schedule"
            title="New Schedule"
            class="primary-button"
            disabled={dateDisabled}
            onclick={openNewScheduleModal}>
          </lightning-button>
          
          <lightning-button
            variant="neutral"
            label="Refresh"
            title="Refresh"
            onclick={refresh}
            disabled={dateDisabled}
            icon-name="utility:refresh"
            class="slds-p-around_xxx-small">
          </lightning-button>

          <!-- Not sure if this is needed, added cause it was in the mockup -->
          <lightning-button-group style="display: none;">
            <lightning-button label="View Mode"></lightning-button>
            <lightning-button label="Edit Mode" variant="brand"></lightning-button>
          </lightning-button-group>
        </div>
      </div>

      <div if:true={showFilters} class="filter-container">
        <div style="display: flex; gap: 16px">
          <div style="display: flex; align-items: center; gap: 8px; margin-right: 16px;">
            <lightning-input 
              type="time" 
              name="start" 
              value={filters.start}
              min="06:00:00.000"
              max="22:00:00.000"
              timezone={tz}
              onchange={changeFilterStart}
              increment="10"
              placeholder="Start Time"
              variant="label-hidden"
            >
            </lightning-input>
  
            <p>-</p>
  
            <lightning-input 
              type="time" 
              name="end" 
              value={filters.end}
              min="06:00:00.000"
              max="22:00:00.000"
              timezone={tz}
              onchange={changeFilterEnd}
              placeholder="End Time"
              variant="label-hidden"
            >
            </lightning-input>
          </div>
          
          <lightning-combobox
            name="progress"
            value={value}
            placeholder="Select Appointment Type"
            options={appointmentTypes}
            onchange={filterChange}
            variant="label-hidden" 
          >
          </lightning-combobox>
  
          <lightning-combobox
            name="progress"
            value={filters.status}
            placeholder="Select Appointment Status"
            options={statusOptions}
            onchange={changeStatusFilter}
            variant="label-hidden"
          >
          </lightning-combobox>
        </div>

        <div style="display: flex; align-items: center; gap: 8px;">
          <lightning-button
            variant="neutral"
            label="Apply Filters"
            title="Apply Filters"
            class="apply-button"
            onclick={applyFilters}>
          </lightning-button>
        
          <lightning-button
            variant="neutral"
            label="Clear Filters"
            title="Clear Filters"
            icon-name="utility:clear"
            class="slds-p-around_xxx-small"
            onclick={clearFilters}>
          </lightning-button>
        </div>
      </div>
    </div>
  </article>

  <!-- Legend / Appointment Rows -->
  <article if:true={appointments} class="slds-card">
    <div style="display: flex; justify-content: space-between;" class="slds-card__header">
      <div class="legend-header">
        <div class="legend-entry">
          <div style="background: #A5D6A7;" class="legend-icon"></div>
          <p>Scheduled</p>
        </div>

        <div class="legend-entry">
          <div style="background: #66BB69;" class="legend-icon"></div>
          <p>Checked In</p>
        </div>

        <div class="legend-entry">
          <div style="background: #43A046;" class="legend-icon"></div>
          <p>Donation Complete</p>
        </div>

        <div class="legend-entry">
          <div style="background: #1B5E1F;" class="legend-icon"></div>
          <p>Paid/Visit Complete</p>
        </div>

        <div class="legend-entry">
          <div style="background: #B0ADAB;" class="legend-icon"></div>
          <p>Late</p>
        </div>

        <div class="legend-entry">
          <div style="background: #EF9A9A;" class="legend-icon"></div>
          <p>Cancelled</p>
        </div>

        <div class="legend-entry">
          <div style="background: #E53835;" class="legend-icon"></div>
          <p>Deferred/Left Center</p>
        </div>

        <div class="legend-entry">
          <div style="background: #B71A1C;" class="legend-icon"></div>
          <p>Missed</p>
        </div>
      </div>

      <div style="display: flex; flex-direction: row; align-items: center; gap: 8px; visibility: hidden;">
        <lightning-combobox style="width: 200px;" variant="label-hidden" placeholder="Sort Data">
        </lightning-combobox>

        <lightning-button label="Cancel Changes" variant="neutral">
        </lightning-button>

        <lightning-button label="Save Changes" variant="brand">
        </lightning-button>
      </div>
    </div>

    <div class="appointment-list-container slds-card__body slds-card__body_inner">
      <div class="appointment-date-header">
        <lightning-formatted-date-time year="numeric" month="long" day="2-digit" weekday="long" value={selectedDate} time-zone="UTC"></lightning-formatted-date-time>
      </div>

      <div class="appointments">
        <div class="appointment-column-header-cell" style="text-align: center;">Time</div>
        <div class="appointment-column-header-cell" style="text-align: center;">Available</div>
        <div class="appointment-column-header-cell" style="text-align: center;">Filled</div>
        <div class="appointment-column-header-cell" style="text-align: left;">Donors</div>
  
        <template for:each={appointments} for:item="appointment" for:index="appointmentIndex">
          <div key={appointment.key} if:false={appointment.filtered} style="background: #F5F0FF;" class="appointment-data-cell">
              <a href={appointment.link} target="_blank">
                <lightning-formatted-time value={appointment.timeString} timezone={tz}></lightning-formatted-time>
              </a>
          </div>

          <div key={appointment.key} if:false={appointment.filtered} style="justify-content: space-evenly;" class="appointment-data-cell">
            <lightning-button-icon icon-name="utility:dash" size="x-small" variant="brand" onclick={minusAvailable}>
            </lightning-button-icon>
            
            <p>{appointment.availability}</p>

            <lightning-button-icon icon-name="utility:add" size="x-small" variant="brand" onclick={plusAvailable}>
            </lightning-button-icon>          
          </div>

          <div key={appointment.key} if:false={appointment.filtered} class="appointment-data-cell">
            {appointment.booked}
          </div>

          <div 
            data-appointment={appointment.Id}  
            data-appointmenttime={appointment.timeString} 
            if:false={appointment.filtered} 
            key={appointment.key} 
            class="appointment-data-cell droppable" 
            title={appointment.key} 
            style="justify-content: flex-start; text-align: left;position: relative; padding: 4px;" 
            ondrop={drop} 
            ondragenter={dragenter} 
            ondragleave={dragleave} 
            ondragover={allowDrop}
          >
              <template for:each={appointment.visits} for:item="donor" for:index="donorIndex">
                  <c-donor-dot oncancelvisit={handleCancelVisit} key={donorId} icon={donor.icon} donor={donor} appointment={appointment} data-appointment={appointment.Id} data-appointmenttime={appointment.timeString}>
                  </c-donor-dot>
              </template>

              <lightning-button style="margin-left: 8px;" icon-name="utility:add" label="Add Visit" variant="base" onclick={plusAvailable} data-id={appointment.id} data-appointment={appointment.Id}  data-appointmenttime={appointment.timeString}>
              </lightning-button>

              <!-- <lightning-button-icon size="large" variant="bare" icon-name="utility:plus"  alternative-text="Settings" title="Settings" data-appointment={appointment.Id}  data-appointmenttime={appointment.timeString}>
              </lightning-button-icon> -->
          </div>
        </template>
      </div>
    </div>
  </article>

  <!-- Message Telling User to select Center/Date -->
  <article if:false={appointments} class="slds-card">
    <div class="no-appointments-container">
      <p class="no-appointments-message-header">No Appointments Found</p>
      <p class="no-appointments-message">Please ensure a center and date have been selected.</p>  
    </div>
  </article>
</template>